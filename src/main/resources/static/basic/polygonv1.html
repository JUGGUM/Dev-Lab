<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <script
      src="https://map.vworld.kr/js/vworldMapInit.js.do?version=2.0&apiKey=0278F082-9F27-309A-A528-11DC46771FA2&domain=http://localhost:63342/"></script>
</head>
<body>
<div id="vmap" style="width:100%;height:500px;left:0px;top:0px"></div>
<button type="button" onclick="completePolygon()">폴리곤 생성</button>
<form id="searchForm" action="#" class="form_data" onsubmit="return false;">
  <input type="hidden" name="request" value="search"/>
  <input type="hidden" name="size" value="100"/>
  <input type="hidden" name="page" value="1"/>
  <input type="hidden" name="type" value="address"/>
  <input type="hidden" name="category" value="parcel"/>
  <input type="hidden" name="format" value="json"/>
  <input type="hidden" name="errorformat" value="json"/>
  <input type="hidden" name="apiKey" value="0278F082-9F27-309A-A528-11DC46771FA2"/>

  <div>
    <input type="text" id="searchValue" name="query" placeholder="검색어를 입력해주세요."/>
    <button id="searchButton" class="btn" onclick="search();">검색</button>
    <br>
    <span> 결과 : </span>
    <span id="res-cnt"></span>
  </div>
</form>
<ul id="searchResults"></ul>
</body>
<script type="text/javascript">
  let vmap = new vw.ol3.Map("vmap", vw.ol3.MapOptions);
  if (typeof vmap === 'undefined') {
    vmap = new vw.ol3.Map("vmap", vw.ol3.MapOptions);
  }

  // 폴리곤 좌표값을 저장할 배열
  let coordinates = [];

  // 스타일 정의
  let style = new ol.style.Style({
    stroke: new ol.style.Stroke({
      color: [0, 255, 0, .7],
      width: 3
    }),
    fill: new ol.style.Fill({
      color: [255, 0, 0, .4]
    })
  });

  // 지도 클릭 이벤트 핸들러
  vmap.on("click", function(evt) {
    let coordinate = evt.coordinate;  // 클릭한 좌표 정보 가져오기
    coordinates.push(coordinate);     // 좌표를 coordinates 배열에 추가
    console.log("좌표 추가: ", coordinate);
    console.log("현재 좌표 배열: ", coordinates);

    // 마커를 지도에 표시하여 클릭된 위치를 시각적으로 보여줌
    let marker = new ol.Feature({
      geometry: new ol.geom.Point(coordinate)
    });

    marker.setStyle(new ol.style.Style({
      image: new ol.style.Circle({
        radius: 5,
        fill: new ol.style.Fill({ color: 'blue' }),
        stroke: new ol.style.Stroke({ color: 'white', width: 2 })
      })
    }));

    let vectorLayer = new ol.layer.Vector({
      source: new ol.source.Vector({
        features: [marker]
      })
    });

    vmap.addLayer(vectorLayer);  // 클릭한 좌표에 마커 추가
  });

  // 폴리곤 생성 완료 버튼을 눌렀을 때 폴리곤 생성
  function completePolygon() {
    if (coordinates.length < 3) {
      alert("폴리곤을 생성하려면 최소 3개의 좌표가 필요합니다.");
      return;
    }

    // 마지막 점과 첫 번째 점을 연결하여 폴리곤을 완성
    coordinates.push(coordinates[0]);

    let polygonFeature = new ol.Feature({
      geometry: new ol.geom.Polygon([coordinates])
    });

    polygonFeature.setStyle(style);

    let vectorLayer = new ol.layer.Vector({
      source: new ol.source.Vector({
        features: [polygonFeature]
      })
    });
    console.log("polygonFeature=====================",polygonFeature);
    console.log("vectorLayer=====================",vectorLayer);
    console.log("vectorLayer.ol_uid=====================",vectorLayer.ol_uid);
    vmap.addLayer(vectorLayer);  // 폴리곤을 지도에 추가
    console.log("폴리곤 생성 완료: ", coordinates);

    // coordinates 배열 초기화 (다음 폴리곤을 위한 준비)
    coordinates = [];
  }
  function search() {

    const searchValue = document.getElementById("searchValue");
    if (searchValue.value === "") {
      alert('검색 내용이 없습니다.');
      return false;
    }
    /*https://burndogfather.com/267 !!!!!!!*/

    const encodedValue = encodeURIComponent(searchValue.value);
    const form = document.getElementById('searchForm');
    form.setAttribute('query', encodedValue);

    /* https://www.vworld.kr/dev/v4dv_search2_s001.do
    * 해당값 반환하는걸로 폴리곤내역에서 일치하는지 확인 */
    console.log("searchForm===========",form)
    $.ajax({
      type: "get",
      url: "https://api.vworld.kr/req/search",
      data: $('#searchForm').serialize(),
      dataType: 'json',
      async: false,
      success: function (data) {
        let searchResults = $('#searchResults');
        searchResults.empty(); // 기존 결과를 지우기

        features = []; // 기존 피처를 초기화

        for (let o in data.response.result.items) {
          if (o == 0) {
            move(data.response.result.items[o].point.x * 1, data.response.result.items[o].point.y * 1);
          }

          // 검색 결과를 li 태그로 변환하여 ul에 추가
          let item = data.response.result.items[o];
          let listItem = $(`<litoken interpolation">${item.point.x}, ${item.point.y}, 1)"><strong>${item.title}</strong> <p>${item.address.road || item.address.parcel}</p></li>`);
          searchResults.append(listItem);

          // Feature 객체에 저장하여 활용
          features[o] = new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.transform([item.point.x * 1, item.point.y * 1], 'EPSG:4326', "EPSG:3857")),
            title: item.title,
            parcel: item.address.parcel,
            road: item.address.road,
            category: item.category,
            point: item.point
          });
          features[o].set("id", item.id);

          let iconStyle = new ol.style.Style({
            image: new ol.style.Icon({
              anchor: [0.5, 10],
              anchorXUnits: 'fraction',
              anchorYUnits: 'pixels',
              src: 'http://map.vworld.kr/images/ol3/marker_blue.png'
            })
          });
          features[o].setStyle(iconStyle);
        }

        let vectorSource = new ol.source.Vector({
          features: features
        });

        let vectorLayer = new ol.layer.Vector({
          source: vectorSource
        });

        vectorLayer.set("vectorLayer", "search_vector");

        map.getLayers().forEach(function (layer) {
          if (layer.get("vectorLayer") == "search_vector") {
            map.removeLayer(layer);
          }
        });
        map.addLayer(vectorLayer);

        console.log(data.response.result.items.length);
        const resCnt = document.getElementById('res-cnt');
        resCnt.innerText = data.response.result.items.length;
      },
      error: function (xhr, stat, err) {}
    });
  }
</script>
</html>
